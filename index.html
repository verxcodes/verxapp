<!doctype html>
<html class="no-js" lang="">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Verx Code Scanner</title>
    <meta name="description" content="The Verx code scanner application.">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="manifest" href="site.webmanifest">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Place favicon.ico in the root directory -->

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
</head>

<body>
    <!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->

    <!-- Add your site or application content here -->

    <script src="js/instascan.min.js"></script>
    <script src='js/jsrsasign-all-min.js'></script>
    <script src="js/vendor/modernizr-3.5.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="js/vendor/jquery-3.2.1.min.js"><\/script>')</script>
    <script src="js/plugins.js"></script>
    <script src="js/main.js"></script>

    <video id="preview"></video>
    <textarea id="output"></textarea>
    <textarea id="pubkey"></textarea>
    <textarea id="sigok"></textarea>
    <script type="text/javascript">

        let scanner = new Instascan.Scanner({
            video: document.getElementById('preview'),
            backgroundScan: false
        });

        scanner.addListener('scan', function (content) {
            checkScan(content);
        });

        Instascan.Camera.getCameras().then(function (cameras) {
            if (cameras.length > 0) {
                scanner.start(cameras[0]);
            } else {
                console.error('No cameras found.');
            }
        }).catch(function (e) {
            console.error(e);
        });

        function checkScan(content) {
            var results = content.split(".");

            var tokens = [];

            var i, len;

            for (i = 0; i < 2; ++i) {
                if (i == 2) {
                    tokens[2] = results[2];
                } else {
                    tokens[i] = b64DecodeUnicode(results[i]);
                }
            }

            tokens[2] = results[2];

            $("#output").text(content);

            var info = tokens[1];
            var info_obj = JSON.parse(info);
            var URL = info_obj['URL'];

            var request = new XMLHttpRequest();
            request.open('GET', URL);
            request.responseType = 'text';

            var sig = tokens[2];

            $("#sigok").text(sig);

            request.onload = function () {

                $("#pubkey").text(request.response);

                var pubkey = KEYUTIL.getKey(request.response);

                var Validity = KJUR.jws.JWS.verifyJWT(content, pubkey, {alg: ['ES384']});

                $("#sigok").text(Validity);

            }
            request.send();
        };

        function b64DecodeUnicode(str) {
            // Going backwards: from bytestream, to percent-encoding, to original string.
            return decodeURIComponent(atob(str).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

    </script>
</body>

</html>